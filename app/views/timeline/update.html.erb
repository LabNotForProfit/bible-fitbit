<%= javascript_include_tag 'jquery.knob', 'data-turbolinks-track' => true %>
<style>
.completed-button {
  display: inline-block;
  width: 200px;
  padding: 8px;
  color: #E74C3C;
  border: 1px solid #E74C3C;
  text-align: center;
  outline: none;
  text-decoration: none;
}
.completed-button-done {
  display: inline-block;
  width: 200px;
  padding: 8px;
  color: #2ECC71;
  border: 1px solid #2ECC71;
  text-align: center;
  outline: none;
  text-decoration: none;
}
</style>
<script>
$(document).ready(function() {
	// Change button CSS and animate knob on button click
	$(".completed-button" ).click(function() {
    	if ($(this).attr('class') == 'completed-button' ) {
        	$(".completed-button").attr('class', 'completed-button-done');
            $('.dial').each(function () {
           		var $this = $(this);
           		var myVal = $this.attr("rel");
           		$this.knob({});
           		$({ value: 0 }).animate({value: myVal}, {
               	duration: 2500,
               	easing: 'swing',
               	step: function () {
                	$this.val(Math.ceil(this.value)).trigger('change');
                }
           	})
		});
        var bookId = $('#bookId').remove().html();
        var requestObject = {
          bookId: bookId
        }
        $.ajax({
          type: 'POST',
          url: '/api/books',
          data: requestObject,
          beforeSend: function(jqXHR, settings) {
            jqXHR.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
          },
          success: function(data) {
            console.log('success');
          }
        });
    	} 
    	else {
        console.log("already completed");
    	}
	});
  if ($('.completed-button-done').length > 0) {
    $('.dial').each(function () {
      var $this = $(this);
      var myVal = $this.attr("rel");
      $this.knob({});
      $({ value: 0 }).animate({value: myVal}, {
        duration: 2500,
        easing: 'swing',
        step: function () {
          $this.val(Math.ceil(this.value)).trigger('change');
        }
      })
   });
  }
});
</script>
<div id="bookId" style="display:none;"><%= @book.id %></div>
<p><%= @book.name %></p>
<h2><%= @passages.collection.first.text.html_safe %></h2>
<input class="dial" value="0" rel="100">
<a class="completed-button<%= if current_user.books.include? @book then '-done' else '' end %>" href="#">COMPLETED</a>

<script>
$(".dial").knob({
    'min':0,
    'max':100,
});
</script>
